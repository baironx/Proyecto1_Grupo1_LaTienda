using System;
using System.Collections.Generic;
using System.Linq;

namespace LaEsquinaApp
{
    public class ClienteService
    {
        private readonly List<Cliente> _clientes;

        public ClienteService(List<Cliente> clientes)
        {
            _clientes = clientes;
        }

        public List<Cliente> Listar()
            => _clientes.OrderBy(c => c.Id).ToList();

        public Cliente BuscarPorId(int id)
            => _clientes.FirstOrDefault(c => c.Id == id);

        public bool ExisteTelefono(string telefono, int? ignorarId = null)
        {
            telefono = (telefono ?? "").Trim();
            return _clientes.Any(c =>
                c.Telefono == telefono &&
                (!ignorarId.HasValue || c.Id != ignorarId.Value));
        }

        public Cliente Agregar(string nombre, string direccion, string telefono, Func<int> getNextId)
        {
            nombre = (nombre ?? "").Trim();
            direccion = (direccion ?? "").Trim();
            telefono = (telefono ?? "").Trim();

            // Validación mínima del módulo (campos)
            if (string.IsNullOrWhiteSpace(nombre) ||
                string.IsNullOrWhiteSpace(direccion) ||
                string.IsNullOrWhiteSpace(telefono))
                throw new Exception("Todos los datos deben estar completos.");

            // Validación mínima del módulo (tel numérico)
            if (!telefono.All(char.IsDigit))
                throw new Exception("Teléfono debe ser numérico.");

            // No repetidos
            if (ExisteTelefono(telefono))
                throw new Exception("No se permite agregar clientes repetidos (teléfono ya existe).");

            var nuevo = new Cliente
            {
                Id = getNextId(),
                Nombre = nombre,
                Direccion = direccion,
                Telefono = telefono,
                Activo = true
            };

            _clientes.Add(nuevo);
            return nuevo;
        }

        public void Modificar(int id, string nombre, string direccion, string telefono)
        {
            var c = BuscarPorId(id);
            if (c == null) throw new Exception("Cliente no encontrado.");

            nombre = (nombre ?? "").Trim();
            direccion = (direccion ?? "").Trim();
            telefono = (telefono ?? "").Trim();

            if (string.IsNullOrWhiteSpace(nombre) ||
                string.IsNullOrWhiteSpace(direccion) ||
                string.IsNullOrWhiteSpace(telefono))
                throw new Exception("Todos los datos deben estar completos.");

            if (!telefono.All(char.IsDigit))
                throw new Exception("Teléfono debe ser numérico.");

            if (ExisteTelefono(telefono, ignorarId: id))
                throw new Exception("Ese teléfono ya pertenece a otro cliente.");

            c.Nombre = nombre;
            c.Direccion = direccion;
            c.Telefono = telefono;
        }

        public void ToggleActivo(int id)
        {
            var c = BuscarPorId(id);
            if (c == null) throw new Exception("Cliente no encontrado.");
            c.Activo = !c.Activo;
        }
    }
}
